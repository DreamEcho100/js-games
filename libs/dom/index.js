import{roundToPrecision as s}from"../math.js";async function y(t){return new Promise(o=>{const n=new Image;n.onload=function(e){const i=e.target;if("naturalHeight"in i&&"naturalWidth"in i&&(i.naturalHeight+i.naturalWidth===0||i.width+i.height===0)){o([new Error("Image has no dimensions"),null]);return}o([null,n])},n.onerror=function(e){const i=e instanceof Error?e.message:typeof e=="string"?e:`Error loading as image: ${t}`;o([new Error(`Failed to load image at ${t}: ${i}`),null])},n.src=t})}async function E(t){return new Promise(o=>{const n=new Audio;n.preload="auto",n.onloadeddata=function(e){o([null,n])},n.onerror=function(e){const i=e instanceof Error?e.message:typeof e=="string"?e:`Error loading as audio: ${t}`;o([new Error(`Failed to load image at ${t}: ${i}`),null])},n.src=t})}async function b(t){const o=await Promise.all(t.map(async e=>{if(e.type==="image"){const[i,l]=await y(e.src);return i?[new Error(`Failed to preload ${e.src}: ${i.message}`),null]:[null,l]}else if(e.type==="audio"){const[i,l]=await E(e.src);return i?[new Error(`Failed to preload ${e.src}: ${i.message}`),null]:[null,l]}return[new Error("Unknown asset type"),null]})),n=new Array(o.length);for(let e=0;e<o.length;e++){const[i,l]=o[e];if(i)return[i,null];n[e]=l}return[null,n]}function x(t,o){const n=document.createElement("link");return n.rel="stylesheet",n.type="text/css",n.href=t,document.head.appendChild(n),o?.register(()=>{n.remove()}),n}function z({canvas:t,ctx:o,onUpdateCanvasSize:n,debounce:e=10,approach:i}){let l=!1;const d=[],r={width:t.width,height:t.height,top:0,left:0,right:t.width,bottom:t.height,x:0,y:0},c=Math.random().toString(36).slice(2),h=document.createElement("style");h.id=`style-${c}`,document.head.appendChild(h),d.push(()=>{h.remove()}),t.setAttribute(`data-${c}`,"true");function m(){const a=window.devicePixelRatio||1;t.width=s(r.width*a,2),t.height=s(r.height*a,2),o.setTransform(1,0,0,1,0,0),o.scale(a,a)}const f=()=>{l=!0;const a=t.getBoundingClientRect();i==="continue-preserve-dpr"&&m(),r.width=s(a.width,2),r.height=s(a.height,2),r.top=s(a.top,2),r.left=s(a.left,2),r.right=s(a.right,2),r.bottom=s(a.bottom,2),r.x=s(a.x,2),r.y=s(a.y,2),n(r)};m(),f(),h.innerHTML=`
    		[data-${c}] {
    			width: ${r.width}px;
    			/* height: ${r.height}px; */
    			aspect-ratio: ${s(r.width/r.height,2)};
    		}
    	`;let u;d.push(()=>{u&&(clearTimeout(u),u=void 0)});const g=()=>{if(u&&clearTimeout(u),l){l=!1;return}u=setTimeout(f,e)};window.addEventListener("resize",g),d.push(()=>{window.removeEventListener("resize",g)});const p=new ResizeObserver(g);d.push(()=>p.disconnect());const w=t.computedStyleMap().get("box-sizing")?.value??getComputedStyle(t).boxSizing??t.style.boxSizing;return p.observe(t,{box:w}),()=>{for(const a of d)a()}}export{z as adjustCanvas,x as injectStylesheetLink,b as loadManyAssets,E as loadOneAudioElement,y as loadOneImageElement};
