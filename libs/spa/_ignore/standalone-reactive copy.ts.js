const O=Symbol("signal");let h=0,l=null,c=new Set,a=!1,p=!1;const C={version:0,lastCleanEpoch:0,dirty:!1,producerNode:void 0,producerLastReadVersion:void 0,producerIndexOfThis:void 0,nextProducerIndex:0,liveConsumerNode:void 0,liveConsumerIndexOfThis:void 0,consumerAllowSignalWrites:!0,consumerIsAlwaysLive:!1,producerMustRecompute(){return!1},producerRecomputeValue(){},consumerMarkedDirty(){},consumerOnSignalRead(e){T(this,e)}};function g(e,r){return Object.is(e,r)}function T(e,r){const n=e.nextProducerIndex++;if(e.producerNode||(e.producerNode=[],e.producerLastReadVersion=[],e.producerIndexOfThis=[]),n<e.producerNode.length&&e.producerNode[n]!==r&&m(e)&&e.producerIndexOfThis){const t=e.producerNode[n];y(t,e.producerIndexOfThis[n])}e.producerNode[n]!==r&&e.producerIndexOfThis&&(e.producerNode[n]=r,e.producerIndexOfThis[n]=m(e)?A(r,e,n):0),e.producerLastReadVersion&&(e.producerLastReadVersion[n]=r.version)}function v(e){const r=l;return l=e,r}function V(){return l===null||l.consumerAllowSignalWrites}function E(e){if(p)throw new Error("Signal read during notification phase");l!==null&&T(l,e)}function A(e,r,n){e.liveConsumerNode||(e.liveConsumerNode=[],e.liveConsumerIndexOfThis=[],e.watched?.());const t=e.liveConsumerNode.length;return e.liveConsumerNode.push(r),e.liveConsumerIndexOfThis&&e.liveConsumerIndexOfThis.push(n),t}function y(e,r){if(!e.liveConsumerNode||!e.liveConsumerIndexOfThis)return;const n=e.liveConsumerNode.length-1;if(r!==n){const t=e.liveConsumerNode[n],o=e.liveConsumerIndexOfThis[n];e.liveConsumerNode[r]=t,e.liveConsumerIndexOfThis[r]=o,t.producerIndexOfThis&&(t.producerIndexOfThis[o]=r)}e.liveConsumerNode.pop(),e.liveConsumerIndexOfThis.pop(),e.liveConsumerNode.length===0&&e.unwatched?.()}function m(e){return e.consumerIsAlwaysLive||e.liveConsumerNode!==void 0&&e.liveConsumerNode.length>0}function S(e){!e.dirty&&e.lastCleanEpoch===h||((e.dirty||e.producerMustRecompute(e))&&(e.producerRecomputeValue(e),e.dirty=!1),e.lastCleanEpoch=h)}function L(e){e.dirty||(e.dirty=!0,e.consumerMarkedDirty.call(e))}function D(e){const r=e.liveConsumerNode;if(!r||r.length===0)return;const n=p;p=!0;try{for(const t of r)L(t)}finally{p=n}}function P(e){const r=Object.create(C);r.value=e,r.equal=g,r.version=0;const n=()=>(E(r),r.value);return n.set=t=>{if(!V())throw new Error("Cannot set signal value during effect execution");r.equal(r.value,t)||(r.value=t,r.version++,h++,D(r),a||x())},n.update=t=>{n.set(t(r.value))},n[O]=r,n}function M(e){const r=Symbol("UNSET"),n=Symbol("COMPUTING"),t=Symbol("ERRORED"),o=Object.create(C);o.value=r,o.error=null,o.equal=g,o.computation=e,o.dirty=!0,o.version=0,o.producerMustRecompute=u=>{const i=u;return i.value===r||i.value===n},o.producerRecomputeValue=u=>{const i=u;if(i.value===n)throw new Error("Detected cycle in computations");const d=i.value;i.value=n;const w=v(i);let f,I=!1;try{i.nextProducerIndex=0,f=i.computation(),I=d!==r&&d!==t&&i.equal(d,f)}catch(N){f=t,i.error=N}finally{v(w),R(i)}if(I){i.value=d;return}i.value=f,i.version++};const s=()=>{if(S(o),E(o),o.value===t)throw o.error;return o.value};return s[O]=o,s}function b(e){let r;const n=o=>{r=o},t=Object.create(C);return t.consumerIsAlwaysLive=!0,t.dirty=!0,t.consumerAllowSignalWrites=!1,t.execute=()=>{if(r){try{r()}catch(s){console.error("Error in effect cleanup:",s)}r=void 0}t.nextProducerIndex=0;const o=v(t);try{e(n)}finally{v(o),R(t),t.dirty=!1}},t.consumerMarkedDirty=()=>{t.dirty||(t.dirty=!0,c.add(t),a||x())},t.execute(),()=>{c.delete(t);const{producerNode:o,producerIndexOfThis:s}=t;if(o&&s)for(let u=0;u<o.length;u++)y(o[u],s[u]);r&&(r(),r=void 0)}}function U(e){if(a){e();return}a=!0;try{e()}finally{a=!1,x()}}function x(){if(c.size===0)return;const e=Array.from(c);c.clear(),e.sort((r,n)=>r.version-n.version);for(const r of e)r.dirty&&r.execute()}function R(e){const{producerNode:r,producerIndexOfThis:n,nextProducerIndex:t}=e;if(!(!r||!n)&&t<r.length){for(let o=t;o<r.length;o++)m(e)&&y(r[o],n[o]);r.length=t,n.length=t,e.producerLastReadVersion&&(e.producerLastReadVersion.length=t)}}export{U as batchSignals,b as createEffect,M as createMemo,P as createSignal};
