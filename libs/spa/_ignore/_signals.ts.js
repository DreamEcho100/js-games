const y=Symbol("signal"),u=[];let c=null,S=1,l=0;const i=new Set;let v=!1;function p(e,t){return{id:S++,version:0,value:e,compute:void 0,cleanup:void 0,error:void 0,dirty:!1,onDirty:void 0,sources:new WeakMap,observers:new Set,name:t}}function d(e){c&&(c.sources.set(e,e.version),e.observers.add(c))}function m(e){const t=Array.from(e.observers);for(const r of t)r.sources.delete(e);e.sources=new WeakMap}function O(e){for(const t of e.observers)t.dirty=!0,t.onDirty&&(l>0?i.add(t):k())}function a(e,t){if(Object.is(e,t))return!0;if(e===null||t===null||typeof e!="object"||typeof t!="object")return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!a(e[n],t[n]))return!1;return!0}if(e.constructor!==t.constructor)return!1;if(e instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp)return e.toString()===t.toString();const r=Object.keys(e),o=Object.keys(t);if(r.length!==o.length)return!1;for(const n of r)if(!Object.prototype.hasOwnProperty.call(t,n)||!a(e[n],t[n]))return!1;return!0}function f(e){if(!e.compute)return;if(u.includes(e)){const r=u.slice(u.indexOf(e)).map(n=>n.name||`Node_${n.id}`).join(" â†’ "),o=new Error(`Cycle detected in reactive graph: ${r}`);console.error(o),e.error=o;return}u.push(e),m(e);const t=c;c=e;try{typeof e.cleanup=="function"&&(e.cleanup(),e.cleanup=void 0);const r=e.compute();e.onDirty&&typeof r=="function"?e.cleanup=r:!e.onDirty&&!a(e.value,r)&&(e.value=r,e.version++,O(e)),e.dirty=!1,e.error=void 0}catch(r){e.error=r,console.error(`Error in ${e.name?e.name:"reactive computation"}:`,r)}finally{u.pop(),c=t}}function b(e){if(!e.compute)return!1;let t=e.dirty;return t||(t=e.dirty===!0),t?(f(e),!0):!1}function h(){l++}function g(){--l===0&&k()}function k(){!v&&i.size>0&&(v=!0,queueMicrotask(()=>{v=!1;const e=Array.from(i);i.clear();for(const t of e)f(t)}))}function A(e,t){const r=p(e,t?.name),o=t?.equals||a,n=()=>(d(r),r.value);return n.set=s=>{if(!o(r.value,s)){h();try{r.value=s,r.version++,O(r)}finally{g()}}},n.update=s=>n.set(s(r.value)),n.peek=()=>r.value,n[y]=r,n}function j(e,t){const r=p(void 0,t?.name);r.compute=e,f(r);const o=()=>{if(b(r),d(r),r.error!==void 0){const n=r.error;throw r.error=void 0,n}return r.value};return o[y]=r,o}function w(e,t){const r=p(void 0,t?.name);return r.compute=e,r.onDirty=()=>{l>0?i.add(r):k()},f(r),()=>{typeof r.cleanup=="function"&&(r.cleanup(),r.cleanup=void 0),m(r),i.delete(r)}}function D(e,t){const r={},o=t?.prefix||"",n=t?.equals;h();try{for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=A(e[s],{name:`${o}${s}`,equals:n}))}finally{g()}return r}function E(e){const t=c;c=null;try{return e()}finally{c=t}}function M(e,t){const r=p(void 0,t?.name);r.compute=e;const o=()=>(b(r),d(r),r.value);return f(r),o[y]=r,o}function q(e){h();try{return e()}finally{g()}}function x(e,t,r){w(()=>{e[t]=r()})}function $(){const e=[];return{run(t){const r=c;c={sources:new WeakMap,observers:new Set,cleanup:void 0,compute:void 0,dirty:!1,error:void 0,id:S++,onDirty:void 0,version:0,value:void 0};const o=t();return m(c),typeof c.cleanup=="function"&&e.push(c.cleanup),c=r,o},dispose(){for(const t of e)typeof t=="function"&&t()}}}function B(e,t){let r;const o=n=>{r=n};w(()=>{r&&r(),r=void 0;const n=e(o);n instanceof Promise&&n.catch(console.error)},t)}export{q as batch,B as createAsyncEffect,D as createBatchedSignals,j as createComputed,w as createEffect,M as createMemo,$ as createScope,A as createSignal,x as ref,E as untrack};
