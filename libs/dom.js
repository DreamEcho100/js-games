import{roundToPrecision as s}from"./math.js";async function y(i){return new Promise(o=>{const t=new Image;t.onload=function(e){const n=e.target;if("naturalHeight"in n&&"naturalWidth"in n&&(n.naturalHeight+n.naturalWidth===0||n.width+n.height===0)){o([new Error("Image has no dimensions"),null]);return}o([null,t])},t.onerror=function(e){const n=e instanceof Error?e.message:typeof e=="string"?e:`Error loading as image: ${i}`;o([new Error(`Failed to load image at ${i}: ${n}`),null])},t.src=i})}async function $(i){return new Promise(o=>{const t=new Audio;t.preload="auto",t.onloadeddata=function(e){o([null,t])},t.onerror=function(e){const n=e instanceof Error?e.message:typeof e=="string"?e:`Error loading as audio: ${i}`;o([new Error(`Failed to load image at ${i}: ${n}`),null])},t.src=i})}async function E(i){const o=await Promise.all(i.map(async e=>{if(e.type==="image"){const[n,l]=await y(e.src);return n?[new Error(`Failed to preload ${e.src}: ${n.message}`),null]:[null,l]}else if(e.type==="audio"){const[n,l]=await $(e.src);return n?[new Error(`Failed to preload ${e.src}: ${n.message}`),null]:[null,l]}return[new Error("Unknown asset type"),null]})),t=new Array(o.length);for(let e=0;e<o.length;e++){const[n,l]=o[e];if(n)return[n,null];t[e]=l}return[null,t]}function x(i,o){const t=document.createElement("link");return t.rel="stylesheet",t.type="text/css",t.href=i,document.head.appendChild(t),o?.register(()=>{t.remove()}),t}function z({canvas:i,ctx:o,onUpdateCanvasSize:t,debounce:e=10,approach:n}){let l=!1;const d=[],r={width:0,height:0,top:0,left:0,right:0,bottom:0,x:0,y:0},g=Math.random().toString(36).slice(2),c=document.createElement("style");c.id=`style-${g}`,document.head.appendChild(c),d.push(()=>{c.remove()}),i.setAttribute(`data-${g}`,"true");const m=()=>{l=!0;const a=i.getBoundingClientRect();if(n==="preserve-dpr"){const h=window.devicePixelRatio||1;i.width=s(a.width*h,2),i.height=s(a.height*h,2),o.setTransform(1,0,0,1,0,0),o.scale(h,h)}r.width=s(a.width,2),r.height=s(a.height,2),r.top=s(a.top,2),r.left=s(a.left,2),r.right=s(a.right,2),r.bottom=s(a.bottom,2),r.x=s(a.x,2),r.y=s(a.y,2),t(r)};m(),c.innerHTML=`
    		[data-${g}] {
    			width: ${r.width}px;
    			/* height: ${r.height}px; */
    			aspect-ratio: ${s(r.width/r.height,2)};
    		}
    	`;let u;d.push(()=>{u&&(clearTimeout(u),u=void 0)});const p=()=>{if(u&&clearTimeout(u),l){l=!1;return}u=setTimeout(m,e)},f=new ResizeObserver(p);d.push(()=>f.disconnect());const w=i.computedStyleMap().get("box-sizing")?.value??getComputedStyle(i).boxSizing??i.style.boxSizing;return f.observe(i,{box:w}),()=>{for(const a of d)a()}}export{z as adjustCanvas,x as injectStylesheetLink,E as loadManyAssets,$ as loadOneAudioElement,y as loadOneImageElement};
