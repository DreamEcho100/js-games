import{roundToPrecision as i}from"./math.js";async function y(n){return new Promise(l=>{const o=new Image;o.onload=function(t){const e=t.target;if("naturalHeight"in e&&"naturalWidth"in e&&(e.naturalHeight+e.naturalWidth===0||e.width+e.height===0)){l([new Error("Image has no dimensions"),null]);return}l([null,o])},o.onerror=function(t){const e=t instanceof Error?t.message:typeof t=="string"?t:`Error loading as image: ${n}`;l([new Error(`Failed to load image at ${n}: ${e}`),null])},o.src=n})}async function w(n){return new Promise(l=>{const o=new Audio;o.preload="auto",o.onloadeddata=function(t){l([null,o])},o.onerror=function(t){const e=t instanceof Error?t.message:typeof t=="string"?t:`Error loading as audio: ${n}`;l([new Error(`Failed to load image at ${n}: ${e}`),null])},o.src=n})}async function x(n){const l=await Promise.all(n.map(async t=>{if(t.type==="image"){const[e,r]=await y(t.src);return e?[new Error(`Failed to preload ${t.src}: ${e.message}`),null]:[null,r]}else if(t.type==="audio"){const[e,r]=await w(t.src);return e?[new Error(`Failed to preload ${t.src}: ${e.message}`),null]:[null,r]}return[new Error("Unknown asset type"),null]})),o=new Array(l.length);for(let t=0;t<l.length;t++){const[e,r]=l[t];if(e)return[e,null];o[t]=r}return[null,o]}function z(n,l){const o=document.createElement("link");return o.rel="stylesheet",o.type="text/css",o.href=n,document.head.appendChild(o),l?.register(()=>{o.remove()}),o}function E({canvas:n,ctx:l,onUpdateCanvasSize:o,debounce:t=100}){const e=n.getBoundingClientRect(),r={width:i(e.width,2),height:i(e.height,2),top:i(e.top,2),left:i(e.left,2),right:i(e.right,2),bottom:i(e.bottom,2),x:i(e.x,2),y:i(e.y,2)},m=()=>{const a=window.devicePixelRatio||1,h=n.getBoundingClientRect();n.width=i(h.width*a,2),n.height=i(h.height*a,2),l.setTransform(1,0,0,1,0,0),l.scale(a,a);const s=n.getBoundingClientRect();r.width=i(s.width,2),r.height=i(s.height,2),r.top=i(s.top,2),r.left=i(s.left,2),r.right=i(s.right,2),r.bottom=i(s.bottom,2),r.x=i(s.x,2),r.y=i(s.y,2),o(r)};m(),n.style.width=`${i(e.width/16,2)}rem`,n.style.aspectRatio=`${i(r.width/r.height,2)}`;const d=[];let u;d.push(()=>{u&&(clearTimeout(u),u=void 0)});const g=()=>{u&&clearTimeout(u),u=setTimeout(m,t)},c=new ResizeObserver(g);d.push(()=>c.disconnect()),n.addEventListener("resize",g),d.push(()=>{n.removeEventListener("resize",g)});const f=n.computedStyleMap().get("box-sizing")?.value??getComputedStyle(n).boxSizing??n.style.boxSizing;c.observe(n,{box:f});const p=document.body.computedStyleMap().get("box-sizing")?.value??getComputedStyle(document.body).boxSizing??document.body.style.boxSizing;return c.observe(document.body,{box:p}),()=>{for(const a of d)a()}}export{E as adjustCanvas,z as injectStylesheetLink,x as loadManyAssets,w as loadOneAudioElement,y as loadOneImageElement};
