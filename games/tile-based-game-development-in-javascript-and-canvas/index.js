import M from"../../libs/core/dom.js";import{adjustCanvas as k}from"../../libs/dom/index.js";import"../../libs/class-names.js";import"../../libs/cleanup.js";import"../../libs/math.js";class F{constructor(e){this.tileFrom=[1,1],this.tileTo=[1,1],this.position=[45,45],this.dimensions=[30,30],this.timeMoved=0,this.delayMove=300,this.directionKeyMap={up:"ArrowUp",right:"ArrowRight",down:"ArrowDown",left:"ArrowLeft"},this.KeysCollection=Object.values(this.directionKeyMap),this.keyDirectionMap=Object.fromEntries(Object.entries(this.directionKeyMap).map(t=>[t[1],[t[0],!1]])),e.registerEvents({keydownCb:t=>{t.key in this.keyDirectionMap&&(this.keyDirectionMap[t.key][1]=!0)},keyupCb:t=>{t.key in this.keyDirectionMap&&(this.keyDirectionMap[t.key][1]=!1)}})}placeAt(e,t,s){this.tileFrom=[t,s],this.tileTo=[t,s],this.position=[t*e.w+(e.w-this.dimensions[0])*.5,s*e.h+(e.h-this.dimensions[1])*.5]}processMovement(e,t){if(this.tileFrom[0]===this.tileTo[0]&&this.tileFrom[1]===this.tileTo[1])return!1;const s=t-this.timeMoved;if(s>=this.delayMove)this.placeAt(e,this.tileTo[0],this.tileTo[1]);else{const o=s/this.delayMove;if(this.tileTo[0]!==this.tileFrom[0]){const i=(this.tileTo[0]-this.tileFrom[0])*o;this.position[0]=(this.tileFrom[0]+i)*e.w+(e.w-this.dimensions[0])*.5}if(this.tileTo[1]!==this.tileFrom[1]){const i=(this.tileTo[1]-this.tileFrom[1])*o;this.position[1]=(this.tileFrom[1]+i)*e.h+(e.h-this.dimensions[1])*.5}}return!0}toMapIndex(e,t,s){return s*e.w+t}update(e,t,s,o){if(!this.processMovement(e,o))for(const i of this.KeysCollection){const[m,c]=this.keyDirectionMap[i];if(!c)continue;let n=!1;switch(m){case"up":this.tileFrom[1]>0&&s[this.toMapIndex(t,this.tileFrom[0],this.tileFrom[1]-1)]==1&&(this.tileTo[1]-=1,n=!0);break;case"down":this.tileFrom[1]<t.h-1&&s[this.toMapIndex(t,this.tileFrom[0],this.tileFrom[1]+1)]==1&&(this.tileTo[1]+=1,n=!0);break;case"left":this.tileFrom[0]>0&&s[this.toMapIndex(t,this.tileFrom[0]-1,this.tileFrom[1])]==1&&(this.tileTo[0]-=1,n=!0);break;case"right":this.tileFrom[0]<t.w-1&&s[this.toMapIndex(t,this.tileFrom[0]+1,this.tileFrom[1])]==1&&(this.tileTo[0]+=1,n=!0);break}if(n){this.timeMoved=o;break}}}draw(e,t=[0,0]){e.fillStyle="#0000ff",e.fillRect(t[0]+this.position[0],t[1]+this.position[1],this.dimensions[0],this.dimensions[1])}}class b{constructor(e){this.screen=e.screen,this.startTile=[0,0],this.endTile=[0,0],this.offset=[0,0]}update(e,t,s,o){this.offset[0]=Math.floor(this.screen[0]*.5-s),this.offset[1]=Math.floor(this.screen[1]*.5-o);const r=[Math.floor(s/e.w),Math.floor(o/e.h)];this.startTile[0]=r[0]-1-Math.ceil(this.screen[0]*.5/e.w),this.startTile[1]=r[1]-1-Math.ceil(this.screen[1]*.5/e.h),this.startTile[0]<0&&(this.startTile[0]=0),this.startTile[1]<0&&(this.startTile[1]=0),this.endTile[0]=r[0]+1+Math.ceil(this.screen[0]*.5/e.w),this.endTile[1]=r[1]+1+Math.ceil(this.screen[1]*.5/e.h),this.endTile[0]>=t.w&&(this.endTile[0]=t.w),this.endTile[1]>=t.h&&(this.endTile[1]=t.h)}draw(e,t,s,o){for(let r=this.startTile[1];r<=this.endTile[1];r++)for(let i=this.startTile[0];i<=this.endTile[0];i++){switch(o[r*s.w+i]){case 0:e.fillStyle="#999999";break;default:e.fillStyle="#eeeeee";break}e.fillRect(this.offset[0]+i*t.w,this.offset[1]+r*t.h,t.w,t.h)}}}const E=await M({cb:async({appId:f,cleanupManager:e,createLayout:t})=>{const s=`${f}-canvas`,o={render:{width:400,height:400},dom:{}};await t(`<small class='block text-center'><em>In Progress</em></small><canvas
				id="${s}"
				width="${o.render.width}"
				height="${o.render.height}"
				class="border border-solid border-gray-300 dark:border-gray-700 mx-auto max-w-full w-5xl"
			></canvas>`);const r=document.getElementById(s);if(!r)throw new Error("Couldn't find the canvas!");const i=r.getContext("2d");if(!i)throw new Error("Couldn't get the canvas context!");const m=k({canvas:r,ctx:i,onUpdateCanvasSize:l=>{o.dom=l}});e.register(m),i.imageSmoothingEnabled=!1;let c=0,n=0,u=0;const y=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,0,0,0,1,0,0,0,0,1,1,1,0,1,0,1,0,0,0,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,0,0,1,0,1,0,0,0,1,1,0,1,1,1,0,1,0,1,1,1,0,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1,0,1,1,1,0,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,0,1,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,1,0,1,1,1,0,0,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,1,0,0,1,0,0,1,0,1,1,1,1,1,1,0,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0,0,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,1,0,1,0,0,0,1,0,1,1,1,1,1,1,1,0,1,1,0,0,1,0,1,0,1,0,1,0,1,0,0,0,0,1,1,0,0,0,0,0,1,0,1,1,1,0,1,0,1,1,1,1,0,1,1,1,0,1,0,0,1,0,0,0,0,0,1,0,1,0,0,1,0,1,1,1,0,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];window.canvas=r,window.ctx=i;const d={w:40,h:40},w={w:20,h:20},h=new F({registerEvents:l=>{e.registerWindowEventListener({type:"keyup",listener:l.keyupCb}),e.registerWindowEventListener({type:"keydown",listener:l.keydownCb})},tile:d});i.font="bold 10pt sans-serif";const a=new b({screen:[o.render.width,o.render.height]});let p;function T(){i.clearRect(0,0,o.render.width,o.render.height);const l=Date.now(),v=Math.floor(Date.now()*.001);v!==c?(c=v,u=n,n=1):n++,h.update(d,w,y,l),a.update(d,w,h.position[0]+h.dimensions[0]/2,h.position[1]+h.dimensions[1]/2),i.fillStyle="#000000",i.fillRect(0,0,a.screen[0],a.screen[1]),a.draw(i,d,w,y),h.draw(i,a.offset),i.fillStyle="#ff0000",i.fillText(`FPS: ${u}`,10,20),p=requestAnimationFrame(T)}e.register(()=>{p&&cancelAnimationFrame(p)}),T()}});export{E as default};
